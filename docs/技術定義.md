# AI執筆システム「ラピュタII」- 技術定義書

## 🏗️ システムアーキテクチャ

### 全体構成
```
┌─────────────────────────────────────────┐
│             Mobile Interface           │
│        (GitHub Mobile + 通知)          │
└─────────────────┬───────────────────────┘
                  │
┌─────────────────▼───────────────────────┐
│            GitHub Platform             │
│  ┌─────────────┐  ┌─────────────────┐   │
│  │   Issues    │  │  GitHub Actions │   │
│  │  (管理UI)    │  │   (自動実行)     │   │
│  └─────────────┘  └─────────────────┘   │
└─────────────────┬───────────────────────┘
                  │
┌─────────────────▼───────────────────────┐
│         Claude Code Environment        │
│  ┌─────────────┐  ┌─────────────────┐   │
│  │ AI執筆エンジン │  │  品質検証システム │   │
│  │ (自動生成)    │  │   (自動評価)     │   │
│  └─────────────┘  └─────────────────┘   │
└─────────────────────────────────────────┘
```

---

## 🤖 AI執筆エンジン

### 1. 章生成システム (ChapterGenerator)
#### 🔧 **コア機能**
```python
class ChapterGenerator:
    def generate_chapter(self, chapter_num: int, config: Dict) -> str:
        """
        章を自動生成する主要メソッド
        
        Parameters:
        - chapter_num: 章番号 (1-8)
        - config: 生成設定 (文字数、セリフ比率等)
        
        Returns:
        - str: 生成された章のMarkdownテキスト
        """
```

#### 📝 **生成プロセス**
1. **プロット解析**: plot_manager からキャラクター・設定情報取得
2. **構造計画**: 4節構成(導入・展開・転回・結末)の自動設計
3. **内容生成**: 各節で以下を生成
   - 環境描写 (世界観・雰囲気)
   - キャラクター交流 (対話・感情)
   - アクションシーン (戦闘・冒険)
   - 内面描写 (心理・成長)
4. **品質調整**: 目標文字数・セリフ比率の自動調整

#### 🎯 **品質パラメータ**
```python
@dataclass
class GenerationConfig:
    target_chars: int = 20000      # 目標文字数
    dialogue_ratio: float = 0.45   # セリフ比率45%
    sections_per_chapter: int = 4  # 4節構成
    paragraphs_per_section: int = 8 # 節あたり8段落
    style: str = "light_novel"     # ライトノベル文体
```

### 2. プロット管理システム (PlotManager)
#### 📚 **データ構造**
```python
@dataclass
class Character:
    name: str                    # キャラクター名
    age: int                    # 年齢
    role: str                   # 役割
    appearance: Dict[str, str]   # 外見描写
    personality: Dict[str, str]  # 性格
    abilities: List[str]         # 能力
    relationships: Dict[str, str] # 人間関係

@dataclass
class PlotChapter:
    number: int                 # 章番号
    title: str                  # 章タイトル
    summary: str                # 章要約
    key_events: List[str]       # 主要イベント
    character_focus: List[str]   # 焦点キャラクター
```

#### 🗃️ **キャラクター管理**
- **リン**: 17歳技術者、風力エンジン専門、明るく好奇心旺盛
- **ソラ**: 16歳守護者、植物治癒能力、物静かで優しい
- **アルテミス**: 人工生命体、戦闘特化、感情学習中
- **ローズ**: 45歳船長、豊富な経験、義手装備
- **グレイソン**: 50歳科学者、古代技術執着、冷酷

### 3. 文体エンジン
#### ✍️ **ライトノベル特化要素**
```python
# 文体パターン
narrative_patterns = [
    "〜していた。",
    "〜という状況だった。", 
    "〜という光景が広がっていた。"
]

# セリフ転換
dialogue_transitions = [
    "と言って、",
    "と呟くと、",
    "と微笑んで、"
]

# 感情表現
emotions = {
    'joy': ['嬉しそうに', '明るく', '楽しげに'],
    'sadness': ['悲しそうに', '沈んだ声で', '寂しげに'],
    'determination': ['決意を込めて', '強い意志で', '毅然として']
}
```

---

## 🔍 品質検証システム

### 1. 検証エンジン (Validator)
#### 📊 **検証項目**
```python
@dataclass
class QualityReport:
    overall_score: float              # 総合スコア (0-1)
    overall_passed: bool              # 合格判定
    character_count: ValidationResult # 文字数検証
    dialogue_ratio: ValidationResult  # セリフ比率検証
    structure: ValidationResult       # 構造検証
    character_consistency: ValidationResult # キャラ一貫性
    plot_consistency: ValidationResult # プロット一貫性
    writing_quality: ValidationResult # 文章品質
```

#### 🎯 **品質基準**
- **文字数**: 20,000文字以上必須
- **セリフ比率**: 30-60%の範囲内
- **構造**: 4節以上、適切な段落数
- **一貫性**: キャラクター・プロット矛盾なし
- **文章品質**: 可読性・語彙・文法の総合評価

### 2. 自動改善システム
#### 🔄 **再生成ロジック**
```python
def regenerate_with_improvements(
    self, 
    chapter_number: int,
    quality_report: QualityReport,
    max_attempts: int = 3
) -> Dict[str, Any]:
    """
    品質基準未達の章を自動改善再生成
    """
```

#### 📈 **改善アルゴリズム**
- 文字数不足 → 目標文字数+20%、節数増加
- セリフ比率過多/不足 → 対話シーン調整
- 構造問題 → 段落分割・構成見直し
- 一貫性問題 → キャラクター設定強化参照

---

## 🚀 自動化ワークフロー

### 1. GitHub Actions設定
#### ⚙️ **ワークフロー定義**
```yaml
name: AI Writing Workflow
on:
  issues:
    types: [opened, edited]
    
jobs:
  ai-writing:
    if: contains(github.event.issue.body, '@claude')
    runs-on: ubuntu-latest
    steps:
      - name: Claude Code Execution
        uses: anthropic/claude-code-action@v1
        with:
          issue-number: ${{ github.event.issue.number }}
          allowed-tools: |
            Bash,Read,Write,Edit,MultiEdit,Glob,Grep
```

#### 📱 **通知システム**
```python
# モバイル通知設定
notification_config = {
    "triggers": [
        "chapter_generated",      # 章生成完了
        "quality_check_failed",   # 品質検証失敗
        "project_completed",      # プロジェクト完了
        "error_occurred"          # エラー発生
    ],
    "channels": ["mobile_push", "github_notification"]
}
```

### 2. 統合ワークフロー (AutoGenerateWorkflow)
#### 🔧 **実行パイプライン**
```python
def generate_single_chapter(
    self, 
    chapter_number: int, 
    config: Optional[Dict[str, Any]] = None,
    validate: bool = True,
    save_output: bool = True
) -> Dict[str, Any]:
    """
    単一章の完全生成ワークフロー
    
    Process:
    1. 章本文生成
    2. ファイル保存
    3. 品質検証実行
    4. レポート生成
    5. 改善提案生成
    """
```

---

## 📱 モバイルインターフェース

### 1. GitHub Mobile連携
#### 🎯 **操作フロー**
```
1. GitHub Mobile アプリ起動
2. Issues タブで新規Issue作成
3. "@claude" メンション + 指示内容
4. Issue作成 → 自動でワークフロー起動
5. プッシュ通知で進捗・完了を確認
6. 生成結果をモバイルで確認
```

#### 📊 **監視ダッシュボード**
- **進捗状況**: 章別完成率グラフ
- **品質指標**: スコア推移チャート
- **エラー状況**: 問題点一覧
- **統計情報**: 文字数・生成時間統計

### 2. リアルタイム通知
#### 🔔 **通知パターン**
```json
{
  "chapter_completed": {
    "title": "✅ 第X章生成完了",
    "body": "文字数: XX,XXX字、品質スコア: 0.XX",
    "action": "結果を確認"
  },
  "quality_issue": {
    "title": "⚠️ 品質基準未達成",
    "body": "第X章で問題検出、自動改善中...",
    "action": "詳細を確認"
  }
}
```

---

## 🗄️ データ管理

### 1. ファイル構造
#### 📁 **ディレクトリ設計**
```
project_root/
├── novel_content/           # 生成コンテンツ
│   ├── chapters/           # 章ファイル群
│   ├── characters/         # キャラクター設定
│   └── plot/              # プロット情報
├── novel_system/          # AI執筆システム
│   ├── auto_generate.py   # 統合ワークフロー
│   ├── chapter_generator.py # 章生成エンジン
│   ├── plot_manager.py    # プロット管理
│   └── validator.py       # 品質検証
├── scripts/               # 実行スクリプト群
├── docs/                  # ドキュメント
└── reports/               # 品質レポート
```

### 2. 設定管理
#### ⚙️ **設定ファイル**
```python
# generation_config.py
DEFAULT_CONFIG = {
    "target_chars": 20000,
    "dialogue_ratio": 0.45,
    "sections_per_chapter": 4,
    "quality_threshold": 0.8,
    "max_retry_attempts": 3,
    "notification_enabled": True
}
```

---

## 🔧 開発・デプロイメント

### 1. 開発環境
#### 💻 **技術スタック**
- **言語**: Python 3.8+
- **フレームワーク**: なし（軽量設計）
- **依存関係**: 標準ライブラリ中心
- **テスト**: pytest + 統合テスト
- **リンター**: black + flake8

#### 🧪 **テスト戦略**
```python
# test_system.py
def test_chapter_generation():
    """章生成機能のテスト"""
    
def test_quality_validation():
    """品質検証機能のテスト"""
    
def test_mobile_workflow():
    """モバイルワークフローのテスト"""
```

### 2. 品質保証
#### ✅ **継続的インテグレーション**
- 自動テスト実行
- コード品質チェック
- 生成コンテンツ品質検証
- パフォーマンステスト

#### 📈 **監視・ログ**
- 詳細実行ログ
- エラー追跡システム
- パフォーマンス指標監視
- ユーザー操作ログ

---

## 🔒 セキュリティ

### 1. 認証・認可
#### 🔐 **アクセス制御**
- GitHub OAuth認証
- リポジトリアクセス権限
- API キー安全管理
- 操作ログ記録

### 2. データ保護
#### 🛡️ **セキュリティ対策**
- Private リポジトリ使用
- 機密情報の暗号化
- 定期的セキュリティ監査
- 脆弱性スキャン

---

## 📊 パフォーマンス仕様

### 1. 処理性能
#### ⚡ **ベンチマーク**
- **章生成時間**: 平均12分/章
- **品質検証時間**: 平均90秒/章
- **メモリ使用量**: 最大512MB
- **CPU使用率**: 平均25%

### 2. スケーラビリティ
#### 📈 **拡張性**
- 並行章生成: 最大3章同時
- 日次処理能力: 10章/日
- 同時ユーザー: 5名まで対応
- ストレージ: 1GB/プロジェクト

---

**この技術定義に基づき、堅牢で効率的なAI執筆システムを構築します。**

---
*最終更新: 2024年12月*
*承認者: テクニカルアーキテクト*