# 20240716 EASTASIA, アジルコア,TANREN３社MT

[https://vimeo.com/984735306/445690eb07?share=copy](https://vimeo.com/984735306/445690eb07?share=copy)

[https://vimeo.com/984735306/445690eb07?share=copy](https://vimeo.com/984735306/445690eb07?share=copy)

▶️ログ：

[GMT20240716-055934_Recording.transcript.vtt](20240716%20EASTASIA,%20%E3%82%A2%E3%82%B7%E3%82%99%E3%83%AB%E3%82%B3%E3%82%A2,TANREN%EF%BC%93%E7%A4%BEMT%20cb1073fdba7b476fa218b921670738c6/GMT20240716-055934_Recording.transcript.vtt)

▶️議事録

> **サーバー負荷に関する緊急会議**
> 
> 
> ---
> 
> ### 議事の要旨:
> 
> Bitmovinの利用増加に伴い、TANRENサーバーの高負荷状態が問題視されている。特に、大量の動画アップロード時にサーバー不調が発生し、メモリ容量不足が原因と考えられる。対応策として、サーバーのメモリ増設が提案され、具体的なスペックや費用、実施タイミングについて議論された。また、Bitmovinの課金に関する懸念から、佐藤氏のクレジットカード情報を登録することになった。さらに、データベースのプラン変更に伴う対応についても話し合われ、7月中には新リソースの準備を完了し、開発環境での動作テストを経て本番環境への切り替えを行うことが決定した。
> 
> ## Bitmovin利用増加とサーバー負荷:
> 
> ### サーバー負荷状況:
> 
> - **サーバー負荷増加の確認** [00:02:54]
>     - 管理画面とムービーの利用状況から、エンコーディングの数値が日に日に増加していることを確認 [00:03:00]
>     - 戸谷さんで見られたような2K以上の閾値を超える現象は、現時点では発生していない [00:03:11]
>     - 重量課金のため、利用が増えるほどAzureからの請求額が増加すると予想される [00:03:28]
> - **サーバー負荷増加の原因** [00:06:20]
>     - エンコード処理よりも、短期間に大量の動画がアップロードされたことが原因と推測 [00:06:20]
>     - TANRENサーバー全体が高負荷状態となり、データエピアからの復旧が困難になる現象が発生 [00:06:48]
>     - サーバープロセスを停止することで復旧できたが、根本的な解決には至っていない [00:07:08]
> - **メモリ不足の可能性** [00:07:28]
>     - サーバー不調の原因は、メモリ容量不足の可能性が高い [00:07:28]
>     - 大量の動画アップロードとファイル書き込み処理が重なり、メモリ負荷が増加したと予想 [00:07:39]
>     - メモリ不足のアラートが頻繁に発生していることから、容量不足が深刻化している [00:07:56]
>     - 1号機のみでメモリ不足が発生しており、2号機では安定したメモリ使用状況を確認 [00:09:10]
>     - 1号機と2号機の違いは、文字起こし処理の有無程度 [00:09:16]
> 
> ### サーバー増強計画:
> 
> - **メモリ増設の提案** [00:10:24]
>     - 1号機のメモリ容量を増加させることを提案 [00:10:24]
>     - 処理内容に対して、現状のメモリ容量は十分ではなく、増設しても大きな影響はないと判断 [00:10:44]
>     - 費用は倍額になるが、性能向上による副次的な効果も期待できる [00:11:03]
> - **具体的なサーバースペック** [00:11:09]
>     - 現状のサーバーは、e2s_v4 (8GBメモリ) を使用 [00:11:09]
>     - メモリ容量を16GBに増設するため、e2ds_v4 (16GBメモリ) への変更を検討 [00:12:08]
>     - メモリ最適化タイプのサーバーも検討されたが、CPU使用率が低いことから見送り [00:16:04]
> - **増設による効果とリスク** [00:19:56]
>     - メモリ増設によって、サーバー不調の発生頻度が減少することが期待される [00:19:56]
>     - 1号機のみ増設することで、サーバー間の負荷バランスが崩れる可能性は低い [00:19:59]
>     - 増設後もログ調査やメモリリークの確認を継続し、状況を監視する [00:20:06]
> 
> ### 増設作業の実施:
> 
> - **実施タイミング** [00:19:02]
>     - 今週中の適切なタイミングで、メモリ増設作業を実施する [00:19:02]
>     - 投稿が落ち着く時間帯を考慮し、19時以降に作業を開始する [00:20:26]
>     - 2号機への負荷集中を避けるため、作業前に2号機への切り替えを行う [00:20:50]
> - **作業内容** [00:20:59]
>     - 1号機のサーバースペックを、e2ds_v4 (16GBメモリ) に変更する [00:20:59]
> - **作業後の確認** [00:21:05]
>     - 増設作業後、サービスの動作確認を行う [00:21:05]
>     - メモリ増設の効果を検証し、必要があればさらなる対応を検討する [00:21:05]
> 
> ## Bitmovinの課金とアカウント管理:
> 
> ### 課金状況の確認:
> 
> - **Azureからの請求** [00:03:28]
>     - Bitmovinは重量課金のため、Azureから利用に応じた請求が発生する [00:03:28]
> - **Bitmovinへのクレジットカード登録** [00:26:02]
>     - Azureの請求とは別に、Bitmovin側にもクレジットカード情報を登録できる [00:26:02]
>     - 現状は登録なしでも課金されているが、支払い停止の可能性を考慮し、登録を検討 [00:26:21]
> 
> ### 佐藤氏のクレジットカード登録:
> 
> - **登録の提案** [00:26:40]
>     - 佐藤氏のAmexカード情報を、Bitmovinに登録することを提案 [00:26:40]
> - **二重課金の懸念** [00:26:45]
>     - AzureとBitmovinの両方にカード情報を登録することで、二重課金が発生する可能性を懸念 [00:26:45]
> - **登録によるメリット** [00:27:36]
>     - 支払い遅延によるサービス停止を防ぐため、事前にカード情報を登録しておくことが望ましい [00:27:36]
> - **二重課金発生時の対応** [00:27:51]
>     - 万が一、二重課金が発生した場合は、状況に応じて対応を検討する [00:27:51]
> 
> ### 登録作業の実施:
> 
> - **カード情報の入力** [00:30:02]
>     - 佐藤氏からチャットワークで送られたAmexカード情報を入力 [00:30:02]
> - **入力内容の修正** [00:31:37]
>     - 氏名とカード番号の入力順序が逆になっていたため修正 [00:31:37]
> - **住所情報の入力** [00:33:53]
>     - 佐藤氏の会社住所を、請求先住所として入力 [00:33:53]
> 
> ### 登録後の確認:
> 
> - **請求経路の確認** [00:29:28]
>     - 実際の請求経路が、Azure経由なのかBitmovin直なのかを確認する [00:29:28]
> - **利用制限の確認** [00:36:49]
>     - 登録したクレジットカードに、利用制限がかかっていないかを確認 [00:36:49]
> 
> ## データベースプランの変更と対応:
> 
> ### プラン変更の概要:
> 
> - **シングルサーバープランの廃止** [00:40:26]
>     - 現在使用しているRDS (データベース) のシングルサーバープランが廃止される [00:40:26]
> - **フレキシブルサーバープランへの移行** [00:40:39]
>     - 廃止に伴い、フレキシブルサーバープランへの移行が必要 [00:40:39]
> 
> ### 移行作業の内容:
> 
> - **新インスタンスの作成** [00:40:39]
>     - フレキシブルサーバープランで、新しいデータベースインスタンスを作成する [00:40:39]
> - **データ移行** [00:40:39]
>     - ダンプリストアを使用して、既存のデータベースから新インスタンスにデータを移行する [00:40:39]
> - **接続先変更** [00:45:15]
>     - アプリケーションのデータベース接続先を、新インスタンスに変更する [00:45:15]
> 
> ### 移行作業の影響:
> 
> - **コスト** [00:42:10]
>     - フレキシブルサーバープランは、シングルサーバープランと同等の機能であればコストは変わらない [00:42:10]
>     - 新機能を利用する場合は、追加コストが発生する可能性がある [00:42:21]
> - **メンテナンス** [00:42:52]
>     - データベース移行作業のため、メンテナンス時間が必要となる [00:42:52]
> - **ユーザーアカウント** [00:44:01]
>     - アプリケーションユーザーはダンプリストアで移行可能 [00:44:01]
>     - 管理者ユーザーはリソース固有のため、移行後に名前とパスワードが変更される [00:44:08]
> 
> ### 移行作業の実施:
> 
> - **リソース準備** [00:46:44]
>     - 7月中には、新インスタンスの作成とデータ移行を完了する [00:46:44]
> - **動作テスト** [00:45:07]
>     - 新インスタンスへの接続設定を行い、開発環境でアプリケーションの動作テストを実施する [00:45:07]
> - **本番環境への切り替え** [00:46:00]
>     - 動作テスト完了後、DNSレコードの切り替えにより、本番環境を新インスタンスに接続する [00:46:00]
> - **実施タイミング** [00:43:02]
>     - 8月中の開発完了後、9月半ばまでにリリースする計画に合わせて、具体的な実施タイミングを決定する [00:43:02]
>     - 9月16日のシングルサーバープラン廃止期限までに、移行作業を完了させる必要がある [00:43:29]
> 

完