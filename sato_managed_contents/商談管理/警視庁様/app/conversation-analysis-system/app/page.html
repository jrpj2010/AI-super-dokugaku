<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>思考3DXYZ会話分析システム</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- Font Awesome Kit代替 -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
  <style>
    /* 追加のカスタムスタイル */
    .bg-gradient-to-br {
      background-image: linear-gradient(to bottom right, var(--tw-gradient-stops));
    }

    .from-slate-50 {
      --tw-gradient-from: #f8fafc;
      --tw-gradient-stops: var(--tw-gradient-from), var(--tw-gradient-to, rgba(248, 250, 252, 0));
    }

    .to-blue-50 {
      --tw-gradient-to: #eff6ff;
    }

    .backdrop-blur-md {
      backdrop-filter: blur(12px);
    }

    .bg-gradient-to-r {
      background-image: linear-gradient(to right, var(--tw-gradient-stops));
    }

    .from-blue-600 {
      --tw-gradient-from: #2563eb;
      --tw-gradient-stops: var(--tw-gradient-from), var(--tw-gradient-to, rgba(37, 99, 235, 0));
    }

    .to-indigo-600 {
      --tw-gradient-to: #4f46e5;
    }

    /* タグ専用のスタイル */
    .tag-gutaika {
      background-color: #38b2ac;
      color: white;
    }

    .tag-chushoka {
      background-color: #805ad5;
      color: white;
    }

    .tag-kouzouka {
      background-color: #38a169;
      color: white;
    }

    .tag-kako {
      background-color: #dd6b20;
      color: white;
    }

    .tag-gendai {
      background-color: #38a169;
      color: white;
    }

    .tag-mirai {
      background-color: #3182ce;
      color: white;
    }

    .tag-shokyu {
      background-color: #d53f8c;
      color: white;
    }

    .tag-chukyu {
      background-color: #d69e2e;
      color: white;
    }

    .tag-jokyu {
      background-color: #4a5568;
      color: white;
    }

    /* 設定モーダル */
    .settings-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 50;
      align-items: center;
      justify-content: center;
    }

    .settings-content {
      background-color: white;
      padding: 24px;
      border-radius: 8px;
      width: 90%;
      max-width: 500px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
  </style>
</head>

<body class="min-h-screen bg-gradient-to-br from-slate-50 to-blue-50">
  <!-- ヘッダー -->
  <header class="sticky top-0 z-10 bg-white/80 backdrop-blur-md border-b border-slate-200">
    <div class="container mx-auto px-4 py-4 flex justify-between items-center">
      <div class="flex items-center gap-2">
        <div
          class="h-10 w-10 rounded-lg bg-gradient-to-br from-blue-600 to-indigo-600 flex items-center justify-center">
          <span class="text-white font-bold text-xl">3D</span>
        </div>
        <div>
          <h1 class="text-xl font-bold text-slate-800">思考3DXYZ分析</h1>
          <p class="text-sm text-slate-500">コミュニケーション戦略分析ツール</p>
        </div>
      </div>
      <div class="flex items-center gap-3">
        <button id="settingsButton"
          class="flex items-center gap-1 px-3 py-1.5 rounded-md border border-slate-300 text-slate-700 text-sm bg-white hover:bg-slate-50">
          <i class="fas fa-cog h-4 w-4"></i>
          <span class="hidden sm:inline">設定</span>
        </button>
      </div>
    </div>
  </header>

  <main class="container mx-auto px-4 py-8 flex flex-col lg:flex-row gap-8">
    <!-- サイドバー -->
    <div class="w-full lg:w-80 flex-shrink-0">
      <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
        <div class="bg-gradient-to-r from-blue-600 to-indigo-600 p-4">
          <h2 class="text-white font-bold text-lg">トーク分析ナビ</h2>
          <p class="text-blue-100 text-sm mt-1">会話の深層を可視化</p>
        </div>

        <div class="p-4 border-b border-slate-200">
          <h3 class="font-medium text-slate-700 mb-3 flex items-center">
            <span
              class="h-5 w-5 rounded-full bg-blue-100 text-blue-600 inline-flex items-center justify-center mr-2 text-xs">
              1
            </span>
            会話テーマ一覧
          </h3>
          <div id="themeNavigationList">
            <p class="px-3 py-2 text-sm text-slate-500 italic">スクリプト分析待ち...</p>
          </div>
        </div>

        <div class="p-4">
          <h3 class="font-medium text-slate-700 mb-3">XYZタグ凡例</h3>

          <div class="space-y-4">
            <div>
              <h4 class="text-sm font-medium text-slate-600 mb-2">X軸 (思考の型)</h4>
              <div class="space-y-2">
                <div class="flex items-center gap-2">
                  <span
                    class="tag-gutaika inline-flex items-center px-2.5 py-0.5 rounded-md text-xs font-medium">具体化</span>
                  <span class="text-xs text-slate-600">具体的な事例、詳細な説明</span>
                </div>
                <div class="flex items-center gap-2">
                  <span
                    class="tag-chushoka inline-flex items-center px-2.5 py-0.5 rounded-md text-xs font-medium">抽象化</span>
                  <span class="text-xs text-slate-600">概念、全体像、大局的視点</span>
                </div>
                <div class="flex items-center gap-2">
                  <span
                    class="tag-kouzouka inline-flex items-center px-2.5 py-0.5 rounded-md text-xs font-medium">構造化</span>
                  <span class="text-xs text-slate-600">仕組み、体系、関係性の整理</span>
                </div>
              </div>
            </div>

            <div>
              <h4 class="text-sm font-medium text-slate-600 mb-2">Y軸 (時間軸)</h4>
              <div class="space-y-2">
                <div class="flex items-center gap-2">
                  <span
                    class="tag-kako inline-flex items-center px-2.5 py-0.5 rounded-md text-xs bg-gray-200 text-gray-700">過去</span>
                  <span class="text-xs text-slate-600">経験、歴史、以前の出来事</span>
                </div>
                <div class="flex items-center gap-2">
                  <span
                    class="tag-gendai inline-flex items-center px-2.5 py-0.5 rounded-md text-xs bg-green-500 text-white">現代</span>
                  <span class="text-xs text-slate-600">現状、課題、今の状況</span>
                </div>
                <div class="flex items-center gap-2">
                  <span
                    class="tag-mirai inline-flex items-center px-2.5 py-0.5 rounded-md text-xs bg-gray-200 text-gray-700">未来</span>
                  <span class="text-xs text-slate-600">予測、展望、将来の計画</span>
                </div>
              </div>
            </div>

            <div>
              <h4 class="text-sm font-medium text-slate-600 mb-2">Z軸 (知識レベル)</h4>
              <div class="space-y-2">
                <div class="flex items-center gap-2">
                  <span
                    class="tag-shokyu inline-flex items-center px-2.5 py-0.5 rounded-md text-xs bg-gray-200 text-gray-700">初級</span>
                  <span class="text-xs text-slate-600">基礎知識、入門レベル</span>
                </div>
                <div class="flex items-center gap-2">
                  <span
                    class="tag-chukyu inline-flex items-center px-2.5 py-0.5 rounded-md text-xs bg-yellow-500 text-white">中級</span>
                  <span class="text-xs text-slate-600">応用知識、ある程度の経験</span>
                </div>
                <div class="flex items-center gap-2">
                  <span
                    class="tag-jokyu inline-flex items-center px-2.5 py-0.5 rounded-md text-xs bg-gray-200 text-gray-700">上級</span>
                  <span class="text-xs text-slate-600">専門知識、高度な知見</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- メインコンテンツ -->
    <div class="flex-grow">
      <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden mb-6">
        <div class="p-6">
          <h2 class="text-2xl font-bold text-slate-800 mb-1">会話分析＆フィードバック</h2>
          <p class="text-slate-500 mb-6">思考3DXYZメソッドによるコミュニケーション戦略分析</p>

          <div class="space-y-4">
            <div>
              <div class="flex items-center justify-between mb-2">
                <h3 class="font-medium text-slate-700 flex items-center gap-2">
                  <span
                    class="h-6 w-6 rounded-full bg-blue-100 text-blue-600 inline-flex items-center justify-center text-xs">
                    1
                  </span>
                  トークスクリプト入力
                </h3>
              </div>
              <div class="bg-slate-50 rounded-lg p-4 border border-slate-200">
                <textarea id="scriptInput"
                  class="min-h-[150px] w-full px-3 py-2 rounded-md bg-white border-slate-300 focus:border-blue-500 focus:ring-blue-500"
                  placeholder="会話内容をタイムスタンプ付きで入力してください。例: [01:01:21.338] 話者A: こんにちは"></textarea>
                <div class="mt-4 flex justify-end">
                  <button id="analyzeButton"
                    class="py-2 px-4 rounded-md bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white flex gap-2 items-center">
                    <i class="fas fa-search h-4 w-4"></i>
                    分析実行
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden" id="analysisResultSection">
        <div class="p-6">
          <h2 class="text-2xl font-bold text-slate-800 mb-6 flex items-center justify-between">
            <span>分析結果</span>
            <span id="analysisStatusBadge"
              class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium border border-slate-300 text-slate-500">
              待機中
            </span>
          </h2>

          <div id="conversationDisplayArea" class="space-y-6">
            <div class="flex flex-col items-center justify-center py-12 text-slate-500">
              <i class="fas fa-info-circle fa-2x mb-3"></i>
              <p>上記に会話スクリプトを入力し、「分析実行」ボタンを押してください。</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <footer class="bg-slate-800 text-slate-300 py-6 mt-12">
    <div class="container mx-auto px-4">
      <div class="flex flex-col md:flex-row justify-between items-center">
        <div class="mb-4 md:mb-0">
          <p class="text-sm">© 2024 AI Conversation Analysis Project</p>
        </div>
        <div class="flex flex-wrap items-center gap-4">
          <div class="text-xs px-3 py-1 rounded-full bg-slate-700">API準備完了</div>
          <div class="text-xs px-3 py-1 rounded-full bg-slate-700 whitespace-nowrap">モデル: gemini-2.5-flash-preview-04-17
          </div>
        </div>
      </div>
    </div>
  </footer>

  <!-- 設定モーダル -->
  <div id="settingsModal" class="settings-modal">
    <div class="settings-content">
      <h2 class="text-xl font-bold text-slate-800 mb-4">設定</h2>

      <div class="mb-4">
        <label for="apiKeyInput" class="block text-sm font-medium text-slate-700 mb-1">Gemini API キー</label>
        <input type="text" id="apiKeyInput"
          class="w-full px-3 py-2 border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
          placeholder="APIキーを入力してください">
      </div>

      <div class="mb-6">
        <label for="modelSelect" class="block text-sm font-medium text-slate-700 mb-1">使用モデル</label>
        <select id="modelSelect"
          class="w-full px-3 py-2 border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
          <option value="gemini-2.5-pro-preview-05-06">gemini-2.5-pro-preview-05-06 (高性能)</option>
          <option value="gemini-2.5-flash-preview-04-17" selected>gemini-2.5-flash-preview-04-17 (デフォルト)</option>
        </select>
      </div>

      <div class="flex justify-end gap-2">
        <button id="closeSettingsButton"
          class="px-4 py-2 border border-slate-300 rounded-md text-slate-700 hover:bg-slate-50">キャンセル</button>
        <button id="saveSettingsButton"
          class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">保存</button>
      </div>
    </div>
  </div>

  <script>
    // バックエンドAPI連携機能
    document.addEventListener('DOMContentLoaded', function () {
      console.log('思考3DXYZ会話分析システム 読み込み完了');

      const settingsButton = document.getElementById('settingsButton');
      const settingsModal = document.getElementById('settingsModal');
      const closeSettingsButton = document.getElementById('closeSettingsButton');
      const saveSettingsButton = document.getElementById('saveSettingsButton');
      const apiKeyInput = document.getElementById('apiKeyInput');
      const modelSelect = document.getElementById('modelSelect');
      const analyzeButton = document.getElementById('analyzeButton');
      const scriptInput = document.getElementById('scriptInput');
      const themeNavigationList = document.getElementById('themeNavigationList');
      const conversationDisplayArea = document.getElementById('conversationDisplayArea');
      const analysisStatusBadge = document.getElementById('analysisStatusBadge');

      const savedApiKey = localStorage.getItem('geminiApiKey_v3') || '';
      const savedModel = localStorage.getItem('geminiModel_v3') || 'gemini-2.5-flash-preview-04-17';
      apiKeyInput.value = savedApiKey;
      modelSelect.value = savedModel;

      settingsButton.addEventListener('click', () => { settingsModal.style.display = 'flex'; });
      closeSettingsButton.addEventListener('click', () => { settingsModal.style.display = 'none'; });
      settingsModal.addEventListener('click', (event) => { if (event.target === settingsModal) settingsModal.style.display = 'none'; });
      saveSettingsButton.addEventListener('click', () => {
        localStorage.setItem('geminiApiKey_v3', apiKeyInput.value);
        localStorage.setItem('geminiModel_v3', modelSelect.value);
        alert('設定を保存しました');
        settingsModal.style.display = 'none';
        updateFooterStatus();
      });

      function updateFooterStatus() {
        const apiStatusElement = document.querySelector('footer .rounded-full:first-child');
        const modelNameElement = document.querySelector('footer .rounded-full:last-child');
        const apiKey = localStorage.getItem('geminiApiKey_v3');
        const modelName = localStorage.getItem('geminiModel_v3') || 'gemini-2.5-flash-preview-04-17';
        if (apiKey && apiKey.trim() !== '') {
          apiStatusElement.textContent = 'API準備完了';
          apiStatusElement.classList.add('bg-green-700');
          apiStatusElement.classList.remove('bg-slate-700');
        } else {
          apiStatusElement.textContent = 'APIキー未設定';
          apiStatusElement.classList.add('bg-red-700');
          apiStatusElement.classList.remove('bg-slate-700', 'bg-green-700');
        }
        modelNameElement.textContent = `モデル: ${modelName}`;
      }
      updateFooterStatus();

      // 新しいマークダウン議事録形式・WEBVTT対応のパーサー (improved version)
      function parseMarkdownScript(scriptText) {
        console.log("★★★ Starting parseMarkdownScript (improved version) ★★★");
        const lines = scriptText.split(/\r?\n|\r/);
        const utterances = [];
        let utteranceIndex = 0;
        let currentMainTopic = "未分類";
        let currentSubTopic = "";
        let currentLevel = 0;

        // 正規表現の定義
        const mainTopicRegex = /^##\s*\[\*\*([^\*]+)\*\*\]/;
        const subTopicRegex = /^###\s*([^:]+):?/;
        // 行頭のマーカー(オプショナル) + 内容 + [話者(オプショナル)][タイムスタンプ]
        const utteranceRegex = /^(\s*(?:-|\*|\+)?\s*)?(?:\*\*(.*?)\*\*|(.*?))\s*(?:\[([^\]\d]+)\])?\s*\[(\d{2}:\d{2}:\d{2}\.\d{3})\]$/;
        // 内容のみでタイムスタンプや話者がない行（見出しや説明文など）は別途判定して除外するか、トピックとして扱う

        lines.forEach(line => {
          const originalLine = line; // 元の行を保持 (インデント判定用)
          const trimmedLine = line.trim();

          if (trimmedLine === '' || trimmedLine.toUpperCase() === 'WEBVTT' || /^#{4,}/.test(trimmedLine) || /^-{3,}$/.test(trimmedLine)) {
            // 空行、WEBVTTヘッダ、H4以上の見出し、水平線はスキップ
            return;
          }

          let match;
          if (match = trimmedLine.match(mainTopicRegex)) {
            currentMainTopic = match[1].trim();
            currentSubTopic = "";
            currentLevel = 0;
            return;
          } else if (match = trimmedLine.match(subTopicRegex)) {
            currentSubTopic = match[1].trim();
            currentLevel = 1;
            return;
          }

          match = utteranceRegex.exec(trimmedLine); // トリムした行でまず試す
          if (!match && line.includes('[') && line.includes(']')) { // トリムでタグが切れた可能性を考慮し、元の行でも試す
            match = utteranceRegex.exec(line);
          }

          if (match) {
            const indentSpaces = (originalLine.match(/^(\s*)/) || ['', ''])[1].length;
            // タブをスペース4つ換算として簡易的にレベルを計算 (より正確なロジックが必要な場合あり)
            const calculatedLevel = Math.floor(indentSpaces / 2);

            // match[2]が太字の内容、match[3]が非太字の内容
            const messageContent = (match[2] || match[3] || '').trim();
            const speaker = match[4] || "不明";
            const timestamp = match[5];

            if (messageContent && timestamp) {
              utterances.push({
                id_in_script: utteranceIndex++,
                speaker: speaker.trim(),
                message: messageContent,
                timestamp: timestamp,
                level: currentLevel + calculatedLevel, // 見出しレベル + インデントレベル
                topic: currentSubTopic || currentMainTopic
              });
            }
          } else if (trimmedLine && !trimmedLine.startsWith("##") && !trimmedLine.startsWith("###")) {
            // タイムスタンプや話者タグがないが、空でも見出しでもない行は、直前の発言の続きとみなすか検討
            // 今回は一旦、独立した情報としてスキップ、またはログだけ出す
            // console.log("Skipping line (no tags/not a heading):". trimmedLine);
          }
        });

        console.log("★★★ Parsed Utterances (improved parser):", JSON.parse(JSON.stringify(utterances)));
        return utterances;
      }

      // analyzeButton のイベントリスナー内で parseScript を parseMarkdownScript に置き換える
      analyzeButton.addEventListener('click', function () {
        const scriptText = scriptInput.value.trim();
        if (!scriptText) { alert('トークスクリプトを入力してください'); return; }
        const apiKey = localStorage.getItem('geminiApiKey_v3');
        if (!apiKey || apiKey.trim() === '') { alert('APIキーが設定されていません。設定ボタンからAPIキーを入力してください。'); demoData.activateSample(); return; }

        if (conversationDisplayArea) {
          conversationDisplayArea.innerHTML = `<div class="flex flex-col items-center justify-center py-12"><div class="w-16 h-16 rounded-full bg-blue-100 flex items-center justify-center mb-4 animate-pulse"><i class="fas fa-sync-alt fa-spin h-8 w-8 text-blue-600"></i></div><h3 class="text-lg font-medium text-slate-700 mb-2">分析処理中...</h3><p class="text-slate-500">しばらくお待ちください</p></div>`;
        } else { console.error("Error: conversationDisplayArea element not found."); alert("表示エリアの初期化に失敗しました。ページをリフレッシュしてみてください。"); return; }
        if (analysisStatusBadge) {
          analysisStatusBadge.textContent = '処理中';
          analysisStatusBadge.classList.remove('border-slate-300', 'text-slate-500');
          analysisStatusBadge.classList.add('bg-blue-500', 'text-white', 'border-blue-500');
        } else { console.error("Error: analysisStatusBadge element not found."); }

        const parsedScript = parseMarkdownScript(scriptText);
        const speakerBlocks = parseScriptToSpeakerBlocks(parsedScript);
        console.log("★★★ All Speaker Blocks (Front-end parsed from Markdown):", JSON.parse(JSON.stringify(speakerBlocks)));
        const currentModelName = modelSelect.value;

        fetch('/api/structure', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ apiKey: apiKey, modelName: currentModelName, speakerBlocks: speakerBlocks })
        })
          .then(response => {
            if (!response.ok) throw new Error(`構造分析APIエラー: ${response.status} ${response.statusText}`);
            return response.json();
          })
          .then(structuredData => {
            const thematicChunks = structuredData;
            if (!thematicChunks || !Array.isArray(thematicChunks) || thematicChunks.length === 0) throw new Error('構造分析結果が空か、期待される形式ではありません。');

            const limitedThemes = thematicChunks.slice(0, 10);

            const themeAnalysisPromises = limitedThemes.map(theme => {
              const originalSpeakerBlockIds = theme.speaker_block_ids;
              const originalThemeTitle = theme.theme_title;
              const originalThemeId = theme.theme_id;

              const speakerBlocksInTheme = originalSpeakerBlockIds
                ? originalSpeakerBlockIds.map(id => speakerBlocks.find(b => b.blockId === id)).filter(b => b)
                : [];

              return fetch('/api/analyze-theme', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  apiKey: apiKey,
                  modelName: currentModelName,
                  themeId: originalThemeId,
                  themeTitle: originalThemeTitle,
                  speakerBlocksInTheme: speakerBlocksInTheme
                })
              })
                .then(response => {
                  if (!response.ok) throw new Error(`テーマ分析APIエラー (ID: ${originalThemeId}): ${response.status}`);
                  return response.json();
                })
                .then(analysisResult => {
                  return {
                    ...analysisResult,
                    theme_id: originalThemeId,
                    theme_title: originalThemeTitle,
                    speaker_block_ids: originalSpeakerBlockIds
                  };
                });
            });
            return Promise.all(themeAnalysisPromises);
          })
          .then(themeResultsWithIds => {
            console.log("★★★ Theme Results passed to displayResults (should include speaker_block_ids):", JSON.parse(JSON.stringify(themeResultsWithIds)));
            displayResults(themeResultsWithIds, speakerBlocks);
            saveAnalysisResults(themeResultsWithIds, scriptText);
          })
          .catch(error => {
            console.error('API呼び出しエラー:', error);
            displayError(error);
            if (confirm('API接続エラーが発生しました。デモモードで表示しますか？')) demoData.activateSample();
          });
      });

      function parseScriptToSpeakerBlocks(parsedScript) {
        if (!parsedScript || parsedScript.length === 0) return [];
        const speakerBlocks = [];
        let currentBlock = null;
        parsedScript.forEach((utterance, index) => {
          const utteranceTimestamp = utterance.timestamp || `発言ID:${utterance.id_in_script}`;
          if (!currentBlock || currentBlock.speaker !== utterance.speaker) {
            if (currentBlock) speakerBlocks.push(currentBlock);
            currentBlock = { speaker: utterance.speaker, messages: [utterance.message], original_utterance_objects: [utterance], startTime: utteranceTimestamp, endTime: utteranceTimestamp, blockId: speakerBlocks.length };
          } else {
            currentBlock.messages.push(utterance.message);
            currentBlock.original_utterance_objects.push(utterance);
            currentBlock.endTime = utteranceTimestamp;
          }
        });
        if (currentBlock) speakerBlocks.push(currentBlock);
        return speakerBlocks;
      }

      function displayResults(themeResults, allSpeakerBlocks) {
        console.log("★★★ displayResults - START ★★★");
        console.log("Received allSpeakerBlocks (first 5):", JSON.parse(JSON.stringify(allSpeakerBlocks.slice(0, 5))));
        console.log("Received themeResults (all):", JSON.parse(JSON.stringify(themeResults)));

        if (analysisStatusBadge) {
          analysisStatusBadge.textContent = '完了';
          analysisStatusBadge.classList.remove('border-slate-300', 'text-slate-500', 'bg-blue-500', 'border-blue-500');
          analysisStatusBadge.classList.add('bg-green-500', 'text-white', 'border-green-500');
        }

        if (themeNavigationList && themeResults && themeResults.length > 0) {
          let themeListHTML = '';
          const limitedNavThemes = themeResults.slice(0, 10);
          limitedNavThemes.forEach((theme, index) => {
            themeListHTML += `<li class="mb-1"><a href="#theme-block-${theme.theme_id || index}" class="block px-3 py-2 rounded-md text-slate-700 hover:bg-slate-100 ${index === 0 ? 'bg-slate-100 font-semibold' : ''}">${theme.theme_title || '無題のテーマ'}</a></li>`;
          });
          themeNavigationList.innerHTML = `<ul class="space-y-1">${themeListHTML}</ul>`;
        } else if (themeNavigationList) {
          themeNavigationList.innerHTML = '<p class="px-3 py-2 text-sm text-slate-500 italic">テーマが見つかりませんでした。</p>';
        }

        let conversationHTML = '';
        const MAX_THEMES_TO_DISPLAY = 10;
        const MAX_UTTERANCES_PER_THEME = 5;

        const displayableThemes = themeResults.slice(0, MAX_THEMES_TO_DISPLAY);

        if (displayableThemes.length === 0) {
          conversationHTML = `<div class="flex flex-col items-center justify-center text-center py-12"><div class="w-16 h-16 rounded-full bg-yellow-100 flex items-center justify-center mb-4"><i class="fas fa-exclamation-triangle h-8 w-8 text-yellow-600"></i></div><h3 class="text-lg font-medium text-slate-700 mb-2">分析結果がありません</h3><p class="text-slate-500">会話テーマを特定できませんでした。</p></div>`;
        } else {
          displayableThemes.forEach((theme, themeIndex) => {
            conversationHTML += `<div id="theme-block-${theme.theme_id || themeIndex}" class="pt-4 mb-6 border-t border-slate-200 first:border-t-0 first:pt-0">
                                 <h3 class="text-xl font-semibold text-blue-700 mb-3 sticky top-16 bg-white py-2 z-5">テーマ: ${theme.theme_title || '無題のテーマ'} (ID: ${theme.theme_id})</h3>`;

            let utteranceCount = 0;
            let currentThemeSpeakerBlocks = [];

            // ★★★ ID照合デバッグログ強化 ★★★
            console.log(`★★★ Processing Theme ID: ${theme.theme_id} ★★★`);
            console.log(`    theme.speaker_block_ids: `, theme.speaker_block_ids);
            console.log(`    typeof theme.speaker_block_ids: `, typeof theme.speaker_block_ids);
            console.log(`    Array.isArray(theme.speaker_block_ids): `, Array.isArray(theme.speaker_block_ids));
            console.log(`    allSpeakerBlocks is array: `, Array.isArray(allSpeakerBlocks));
            console.log(`    allSpeakerBlocks length: `, allSpeakerBlocks ? allSpeakerBlocks.length : 'undefined');
            // ★★★ ここまで ★★★

            if (theme.speaker_block_ids && Array.isArray(theme.speaker_block_ids) && allSpeakerBlocks && allSpeakerBlocks.length > 0) {
              currentThemeSpeakerBlocks = theme.speaker_block_ids.map(id_from_theme => {
                const foundBlock = allSpeakerBlocks.find(b => b.blockId === id_from_theme);
                // console.log(`    - Searching for blockId: ${id_from_theme} ... Found:`, foundBlock ? 'Yes' : 'No'); // このログは一旦コメントアウト
                return foundBlock;
              }).filter(b => b);
            } else {
              console.warn(`    Condition FAILED for Theme ID: ${theme.theme_id} - speaker_block_ids was problematic or allSpeakerBlocks empty.`);
            }

            if (currentThemeSpeakerBlocks.length > 0) {
              const limitedUtterances = currentThemeSpeakerBlocks.slice(0, MAX_UTTERANCES_PER_THEME);
              for (const block of limitedUtterances) {
                if (utteranceCount >= MAX_UTTERANCES_PER_THEME && currentThemeSpeakerBlocks.length > MAX_UTTERANCES_PER_THEME) { // 5件超の場合のみ省略メッセージ
                  conversationHTML += '<div class="text-center text-sm text-slate-500 py-3"><i class="fas fa-ellipsis-h mr-2"></i>このテーマの以降の発言は省略されました</div>';
                  break; // MAX_UTTERANCES_PER_THEME を超えたらループを抜けるのは limitedUtterances で制御済みなので不要
                }
                const isSato = block.speaker.toLowerCase().includes('sato') || block.speaker.toLowerCase().includes('佐藤');
                const messageContainerClass = isSato ? 'justify-end' : 'justify-start';
                const speakerIconClass = isSato ? 'bg-blue-600' : 'bg-green-500';
                const speakerInitial = block.speaker.substring(0, 1) || '？';
                const utteranceBubbleClass = isSato ? 'bg-blue-500 text-white' : 'bg-green-100 text-green-800';
                const analysisContainerClass = isSato ? 'ml-auto mr-12' : 'mr-auto ml-12';
                const messageText = block.messages.join('<br>');

                conversationHTML += `
                    <div class="conversation-block mb-5">
                        <div class="message-container flex items-start space-x-3 ${messageContainerClass}">
                        ${!isSato ? `<div class="speaker-icon text-white h-10 w-10 rounded-full flex items-center justify-center flex-shrink-0 ${speakerIconClass}">${speakerInitial}</div>` : ''}
                        <div class="utterance-bubble p-3 rounded-lg max-w-xl shadow ${utteranceBubbleClass}">
                            ${messageText}
                        </div>
                        ${isSato ? `<div class="speaker-icon text-white h-10 w-10 rounded-full flex items-center justify-center flex-shrink-0 ${speakerIconClass}">${speakerInitial}</div>` : ''}
                        </div>
                        <div class="analysis-container mt-2 pl-3 max-w-xl ${analysisContainerClass}">
                        <div class="analysis bg-slate-50 p-3 rounded-lg border border-slate-200 text-xs">
                            <span class="analysis-title text-xs font-semibold text-slate-600 mb-1 block">思考分析 (この発言)</span>
                            <div class="flex space-x-3">
                            <div class="left-column flex-none w-2/5">
                                <div class="xyz-visualization space-y-0.5">
                                <div class="axis-group flex items-center"><span class="axis-label font-medium text-slate-500 w-7">X軸:</span>
                                    <div class="viz-tag-container flex space-x-1">
                                    <span class="px-1.5 py-0.5 rounded text-xs ${theme.analysis_X && theme.analysis_X.category === '具体化' ? 'bg-teal-500 text-white' : 'bg-gray-200 text-gray-700'}">具体化</span>
                                    <span class="px-1.5 py-0.5 rounded text-xs ${theme.analysis_X && theme.analysis_X.category === '抽象化' ? 'bg-purple-500 text-white' : 'bg-gray-200 text-gray-700'}">抽象化</span>
                                    <span class="px-1.5 py-0.5 rounded text-xs ${theme.analysis_X && theme.analysis_X.category === '構造化' ? 'bg-green-500 text-white' : 'bg-gray-200 text-gray-700'}">構造化</span>
                                    </div>
                                </div>
                                <div class="axis-group flex items-center"><span class="axis-label font-medium text-slate-500 w-7">Y軸:</span>
                                    <div class="viz-tag-container flex space-x-1">
                                    <span class="px-1.5 py-0.5 rounded text-xs ${theme.analysis_Y && theme.analysis_Y.category === '過去' ? 'bg-orange-500 text-white' : 'bg-gray-200 text-gray-700'}">過去</span>
                                    <span class="px-1.5 py-0.5 rounded text-xs ${theme.analysis_Y && theme.analysis_Y.category === '現代' ? 'bg-lime-600 text-white' : 'bg-gray-200 text-gray-700'}">現代</span>
                                    <span class="px-1.5 py-0.5 rounded text-xs ${theme.analysis_Y && theme.analysis_Y.category === '未来' ? 'bg-cyan-500 text-white' : 'bg-gray-200 text-gray-700'}">未来</span>
                                    </div>
                                </div>
                                <div class="axis-group flex items-center"><span class="axis-label font-medium text-slate-500 w-7">Z軸:</span>
                                    <div class="viz-tag-container flex space-x-1">
                                    <span class="px-1.5 py-0.5 rounded text-xs ${theme.analysis_Z && theme.analysis_Z.category === '初級' ? 'bg-pink-500 text-white' : 'bg-gray-200 text-gray-700'}">初級</span>
                                    <span class="px-1.5 py-0.5 rounded text-xs ${theme.analysis_Z && theme.analysis_Z.category === '中級' ? 'bg-yellow-400 text-gray-800' : 'bg-gray-200 text-gray-700'}">中級</span>
                                    <span class="px-1.5 py-0.5 rounded text-xs ${theme.analysis_Z && theme.analysis_Z.category === '上級' ? 'bg-indigo-500 text-white' : 'bg-gray-200 text-gray-700'}">上級</span>
                                    </div>
                                </div>
                                </div>
                                <p class="comment text-slate-600 mt-1 italic">解説：${theme.theme_summary || '要約準備中...'}</p>
                            </div>
                            <div class="right-column flex-1 border-l border-slate-300 pl-3">
                                <h4 class="feedback-title font-semibold text-slate-600 mb-0.5">評価</h4>
                                <div class="feedback-section space-y-0.5">
                                ${generateFeedbackHTML(theme.communication_feedback, theme.analysis_X, 'X軸')}
                                ${generateFeedbackHTML(theme.communication_feedback, theme.analysis_Y, 'Y軸')}
                                ${generateFeedbackHTML(theme.communication_feedback, theme.analysis_Z, 'Z軸')}
                                <p class="mt-1"><strong>アドバイス:</strong> ${theme.communication_feedback ? theme.communication_feedback.advice || '-' : '-'}</p>
                                </div>
                            </div>
                            </div>
                        </div>
                        </div>
                    </div>`;
                utteranceCount++; // このカウンターは limitedUtterances のループ内でインクリメントする意味は薄いが、残しておいても害はない
              }
              if (currentThemeSpeakerBlocks.length > MAX_UTTERANCES_PER_THEME) { // 省略メッセージの表示判定を修正
                conversationHTML += '<div class="text-center text-sm text-slate-500 py-3"><i class="fas fa-ellipsis-h mr-2"></i>このテーマの以降の発言は省略されました</div>';
              }
            } else {
              conversationHTML += '<p class="text-sm text-slate-500 italic py-2">このテーマには表示可能な発言がありません。</p>';
            }
            conversationHTML += '</div>';
          });
        }

        if (conversationDisplayArea) {
          conversationDisplayArea.innerHTML = conversationHTML;
          if (displayableThemes.length > 0 && document.getElementById(`theme-block-${displayableThemes[0].theme_id || 0}`)) {
            document.getElementById(`theme-block-${displayableThemes[0].theme_id || 0}`).scrollIntoView({ behavior: 'smooth', block: 'start' });
            updateActiveThemeInNav(`theme-block-${displayableThemes[0].theme_id || 0}`);
          }
        } else {
          console.error("Error: conversationDisplayArea not found for final rendering.");
        }

        themeResults.forEach(theme => {
          if (theme.speaker_block_ids && allSpeakerBlocks) {
            console.log(`★★★ Matching for Theme ID: ${theme.theme_id}, Title: ${theme.theme_title}`);
            theme.speaker_block_ids.forEach(id_from_theme => {
              const foundBlock = allSpeakerBlocks.find(b => b.blockId === id_from_theme);
              console.log(`  - Theme ID ${theme.theme_id} wants blockId: ${id_from_theme} (type: ${typeof id_from_theme}). Found in allSpeakerBlocks:`,
                foundBlock ? `Yes, blockId: ${foundBlock.blockId} (type: ${typeof foundBlock.blockId})` : 'No');
              if (foundBlock === undefined && allSpeakerBlocks.some(b => String(b.blockId) === String(id_from_theme))) {
                console.warn(`    Potential type mismatch for ID ${id_from_theme}?`);
              }
            });
          }
        });
      }

      function updateActiveThemeInNav(activeThemeId) {
        const navLinks = themeNavigationList.querySelectorAll('a');
        navLinks.forEach(link => {
          link.classList.remove('bg-slate-100', 'font-semibold');
          if (link.getAttribute('href') === `#${activeThemeId}`) {
            link.classList.add('bg-slate-100', 'font-semibold');
          }
        });
      }

      window.addEventListener('scroll', () => {
        let currentThemeId = '';
        const themeBlocks = document.querySelectorAll('div[id^="theme-block-"]');
        themeBlocks.forEach(block => {
          const rect = block.getBoundingClientRect();
          if (rect.top <= 150 && rect.bottom >= 150) {
            currentThemeId = block.id;
          }
        });
        if (currentThemeId) {
          updateActiveThemeInNav(currentThemeId);
        }
      });

      function generateFeedbackHTML(feedback, analysis, axisName) {
        if (!analysis) return '';
        let evaluationText = '-';
        let evaluationClass = 'text-slate-700';
        if (feedback && feedback.evaluation) {
          switch (feedback.evaluation.toLowerCase()) {
            case 'good': evaluationText = '良い'; evaluationClass = 'text-green-600 font-semibold'; break;
            case 'ok': evaluationText = '問題なし'; evaluationClass = 'text-blue-600 font-semibold'; break;
            case 'considerationneeded': evaluationText = '要検討'; evaluationClass = 'text-orange-500 font-semibold'; break;
            case 'needs improvement': evaluationText = '改善要'; evaluationClass = 'text-red-500 font-semibold'; break;
            default: evaluationText = feedback.evaluation;
          }
        }
        return `<div class="mb-0.5"><span class="font-medium text-slate-500">${axisName} (${analysis.category || '-'}):</span> <span class="${evaluationClass}">${evaluationText}</span><span class="text-slate-600"> - ${analysis.reason || '-'}</span></div>`;
      }

      function displayError(error) {
        if (analysisStatusBadge) {
          analysisStatusBadge.textContent = 'エラー';
          analysisStatusBadge.classList.remove('border-slate-300', 'text-slate-500', 'bg-blue-500', 'border-blue-500');
          analysisStatusBadge.classList.add('bg-red-500', 'text-white', 'border-red-500');
        }
        if (conversationDisplayArea) {
          conversationDisplayArea.innerHTML = `<div class="flex flex-col items-center justify-center text-center py-12"><div class="w-16 h-16 rounded-full bg-red-100 flex items-center justify-center mb-4"><i class="fas fa-exclamation-circle h-8 w-8 text-red-600"></i></div><h3 class="text-lg font-medium text-slate-700 mb-2">エラーが発生しました</h3><p class="text-red-600 mb-2">${error.message}</p><p class="text-slate-500 text-sm">APIキー, ネットワーク, またはスクリプト形式を確認してください</p></div>`;
        } else {
          console.error("Error: conversationDisplayArea not found for error display.");
        }
      }

      function saveAnalysisResults(analysisResults, scriptText) {
        try {
          const savedResults = localStorage.getItem('savedAnalysisResults') ? JSON.parse(localStorage.getItem('savedAnalysisResults')) : [];
          const newResult = { id: Date.now().toString(), timestamp: new Date().toISOString(), scriptText: scriptText, analysisResults: analysisResults };
          savedResults.push(newResult);
          localStorage.setItem('savedAnalysisResults', JSON.stringify(savedResults));
          console.log('分析結果をローカルストレージに保存しました');
        } catch (error) { console.error('分析結果の保存に失敗しました:', error); }
      }

      const demoData = {
        sampleDataAvailable: true,
        activateSample: function () {
          scriptInput.value = `[01:03:20.910] 今石から高師氏、島表氏へTeamsで別途連絡 [会話記]\n[01:03:30.470] 佐藤勝彦: テレビ電話で本人確認するというプロセスがあって、そこで何か顔を偽装しようとするケースがないか気にしています。\n[01:03:45.820] 警察: その通りです。現在この方法が多く使われています。具体的に可能性はあるのでしょうか？\n[01:04:02.150] 佐藤勝彦: 技術的には完全にリアルタイムで顔を入れ替えることが可能です。スマホのカメラから入力した映像をAIで変換してそのまま出力できます。\n[01:04:20.630] 佐藤勝彦: ただし、日本のAI活用レベルはまだ高くありません。高度なフェイクを実現するには相応の技術リテラシーが必要です。顔のフェイク精度は高いものが作れますが、声まで自然に被せるのはまだ難しい部分もあります。\n[01:04:45.300] 佐藤勝彦: 私たちは企業教育の一環でAI技術を扱っており、犯罪を助長するようなソリューションは提供しません。しかし、世の中にはアンダーグラウンドなツール、特に中国製のものが多く存在し、それらを使えば悪用は容易に想像できます。\n[01:05:10.750] 警察: なるほど。具体的にどういったツールがあるのでしょうか？\n[01:05:20.120] 佐藤勝彦: 例えば「DeepFake」と呼ばれる技術があります。これは十分な量の顔画像さえあれば、動画内の人物の顔を別の人物の顔に差し替えられます。最近では、わずか1枚の写真からでもリアルタイムでフェイクを生成できる技術も登場しています。`;
          setTimeout(() => {
            const results = [
              { theme_id: 1, theme_title: "AI顔偽装技術の現状と脅威", theme_summary: "テレビ電話による本人確認プロセスにおけるAI顔偽装技術の可能性と脅威について議論されている。", analysis_X: { category: "具体化", reason: "DeepFake等の具体例を提示。" }, analysis_Y: { category: "現代", reason: "現在の技術状況を説明。" }, analysis_Z: { category: "中級", reason: "専門用語を含むが平易に解説。" }, communication_feedback: { evaluation: "Good", advice: "具体的で分かりやすい説明。" }, speaker_block_ids: [1, 2, 3, 4, 5, 6, 7] },
              { theme_id: 2, theme_title: "日本のAI活用レベルと技術的障壁", theme_summary: "日本のAI技術普及の現状と課題について議論。", analysis_X: { category: "抽象化", reason: "日本のAI活用レベルという概念を提示。" }, analysis_Y: { category: "現代", reason: "現在の日本の状況を説明。" }, analysis_Z: { category: "中級", reason: "一般的な技術知識で理解可能。" }, communication_feedback: { evaluation: "Neutral", advice: "具体的なデータを示すとより良い。" }, speaker_block_ids: [3] }
            ];
            displayResults(results, parseScriptToSpeakerBlocks(scriptInput.value));
            if (analysisStatusBadge) { analysisStatusBadge.textContent = 'デモ表示'; analysisStatusBadge.className = 'inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-400 text-yellow-800'; }
            if (conversationDisplayArea) { conversationDisplayArea.innerHTML = '<p class="text-center py-8 text-slate-600">デモモードがアクティブです。実際の分析結果は表示されません。</p><p class="text-center text-xs text-slate-500">(デモデータ表示ロジックはコメントアウトされています)</p>'; }
          }, 1000);
        }
      };
    });
  </script>
</body>

</html>
