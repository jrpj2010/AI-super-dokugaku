// Gen-Spa Style Validator - „Çπ„Çø„Ç§„É´„ÅÆ‰∏ÄË≤´ÊÄß„ÇíËá™ÂãïÊ§úË®º„Éª‰øÆÊ≠£

(function() {
    'use strict';

    // „Çπ„Çø„Ç§„É´„É´„Éº„É´„ÅÆÂÆöÁæ©
    const STYLE_RULES = {
        // „Çø„Ç§„Éà„É´ÈöéÂ±§
        titles: {
            h1: {
                fontSize: { min: 42, max: 48, unit: 'px' },
                fontWeight: [700, 'bold'],
                lineHeight: { min: 1.1, max: 1.3 },
                color: ['#00447c', '#006699'],
                marginBottom: { min: 20, max: 40, unit: 'px' }
            },
            h2: {
                fontSize: { min: 32, max: 38, unit: 'px' },
                fontWeight: [700, 'bold'],
                lineHeight: { min: 1.2, max: 1.4 },
                color: ['#00447c', '#006699'],
                marginBottom: { min: 16, max: 32, unit: 'px' }
            },
            h3: {
                fontSize: { min: 24, max: 28, unit: 'px' },
                fontWeight: [600, 700, 'bold'],
                lineHeight: { min: 1.3, max: 1.5 },
                marginBottom: { min: 12, max: 24, unit: 'px' }
            }
        },
        
        // „ÉÜ„Ç≠„Çπ„ÉàË¶ÅÁ¥†
        text: {
            p: {
                fontSize: { min: 14, max: 16, unit: 'px' },
                lineHeight: { min: 1.5, max: 1.8 },
                marginBottom: { min: 12, max: 20, unit: 'px' }
            },
            li: {
                fontSize: { min: 14, max: 16, unit: 'px' },
                lineHeight: { min: 1.5, max: 1.8 },
                marginBottom: { min: 8, max: 12, unit: 'px' }
            }
        },
        
        // „Ç´„Éº„ÉâË¶ÅÁ¥†
        cards: {
            '.stat-card': {
                padding: { min: 20, max: 32, unit: 'px' },
                borderLeftWidth: { min: 3, max: 4, unit: 'px' },
                backgroundColor: ['#f8f9fa', '#f5f5f5']
            },
            '.tool-card': {
                padding: { min: 20, max: 32, unit: 'px' },
                borderLeftWidth: { min: 3, max: 4, unit: 'px' }
            }
        },
        
        // ÈñìÈöî„ÅÆ‰∏ÄË≤´ÊÄß
        spacing: {
            sectionMargin: { min: 40, max: 60, unit: 'px' },
            elementGap: { min: 16, max: 32, unit: 'px' }
        }
    };

    // Ê§úË®ºÁµêÊûú„Çí‰øùÂ≠ò
    let validationResults = [];

    // „Çπ„Çø„Ç§„É´„ÇíÊ§úË®º
    function validateStyles() {
        console.log('üîç Gen-Spa „Çπ„Çø„Ç§„É´Ê§úË®º„ÇíÈñãÂßã...');
        validationResults = [];
        
        // „Çø„Ç§„Éà„É´Ë¶ÅÁ¥†„ÅÆÊ§úË®º
        validateTitleHierarchy();
        
        // „ÉÜ„Ç≠„Çπ„ÉàË¶ÅÁ¥†„ÅÆÊ§úË®º
        validateTextElements();
        
        // „Ç´„Éº„ÉâË¶ÅÁ¥†„ÅÆÊ§úË®º
        validateCardElements();
        
        // ÈñìÈöî„ÅÆÊ§úË®º
        validateSpacing();
        
        // Ëâ≤„ÅÆ‰∏ÄË≤´ÊÄß
        validateColors();
        
        return validationResults;
    }

    // „Çø„Ç§„Éà„É´ÈöéÂ±§„ÅÆÊ§úË®º
    function validateTitleHierarchy() {
        const titles = {
            h1: document.querySelectorAll('.title, h1'),
            h2: document.querySelectorAll('.section-title, h2'),
            h3: document.querySelectorAll('h3')
        };
        
        Object.entries(titles).forEach(([tag, elements]) => {
            elements.forEach((elem, index) => {
                const computed = window.getComputedStyle(elem);
                const rules = STYLE_RULES.titles[tag];
                
                // „Éï„Ç©„É≥„Éà„Çµ„Ç§„Ç∫Ê§úË®º
                const fontSize = parseFloat(computed.fontSize);
                if (fontSize < rules.fontSize.min || fontSize > rules.fontSize.max) {
                    validationResults.push({
                        element: elem,
                        type: 'fontSize',
                        current: fontSize,
                        expected: rules.fontSize,
                        severity: 'high'
                    });
                }
                
                // Ë°åÈñìÊ§úË®º
                const lineHeight = parseFloat(computed.lineHeight) / fontSize;
                if (lineHeight < rules.lineHeight.min || lineHeight > rules.lineHeight.max) {
                    validationResults.push({
                        element: elem,
                        type: 'lineHeight',
                        current: lineHeight,
                        expected: rules.lineHeight,
                        severity: 'medium'
                    });
                }
                
                // „Éû„Éº„Ç∏„É≥Ê§úË®º
                const marginBottom = parseFloat(computed.marginBottom);
                if (marginBottom < rules.marginBottom.min || marginBottom > rules.marginBottom.max) {
                    validationResults.push({
                        element: elem,
                        type: 'marginBottom',
                        current: marginBottom,
                        expected: rules.marginBottom,
                        severity: 'low'
                    });
                }
            });
        });
    }

    // „ÉÜ„Ç≠„Çπ„ÉàË¶ÅÁ¥†„ÅÆÊ§úË®º
    function validateTextElements() {
        const textElements = {
            p: document.querySelectorAll('p'),
            li: document.querySelectorAll('li')
        };
        
        Object.entries(textElements).forEach(([tag, elements]) => {
            elements.forEach(elem => {
                const computed = window.getComputedStyle(elem);
                const rules = STYLE_RULES.text[tag];
                
                const fontSize = parseFloat(computed.fontSize);
                if (fontSize < rules.fontSize.min || fontSize > rules.fontSize.max) {
                    validationResults.push({
                        element: elem,
                        type: 'fontSize',
                        current: fontSize,
                        expected: rules.fontSize,
                        severity: 'medium'
                    });
                }
            });
        });
    }

    // „Ç´„Éº„ÉâË¶ÅÁ¥†„ÅÆÊ§úË®º
    function validateCardElements() {
        Object.entries(STYLE_RULES.cards).forEach(([selector, rules]) => {
            const elements = document.querySelectorAll(selector);
            
            elements.forEach(elem => {
                const computed = window.getComputedStyle(elem);
                
                // „Éë„Éá„Ç£„É≥„Ç∞Ê§úË®º
                const padding = parseFloat(computed.paddingTop);
                if (padding < rules.padding.min || padding > rules.padding.max) {
                    validationResults.push({
                        element: elem,
                        type: 'padding',
                        current: padding,
                        expected: rules.padding,
                        severity: 'medium'
                    });
                }
            });
        });
    }

    // ÈñìÈöî„ÅÆÊ§úË®º
    function validateSpacing() {
        const sections = document.querySelectorAll('.slide-container');
        
        sections.forEach((section, index) => {
            if (index > 0) {
                const prevSection = sections[index - 1];
                const gap = section.offsetTop - (prevSection.offsetTop + prevSection.offsetHeight);
                
                if (gap < STYLE_RULES.spacing.sectionMargin.min || 
                    gap > STYLE_RULES.spacing.sectionMargin.max) {
                    validationResults.push({
                        element: section,
                        type: 'sectionSpacing',
                        current: gap,
                        expected: STYLE_RULES.spacing.sectionMargin,
                        severity: 'low'
                    });
                }
            }
        });
    }

    // Ëâ≤„ÅÆ‰∏ÄË≤´ÊÄß„ÇíÊ§úË®º
    function validateColors() {
        const primaryColors = ['#00447c', '#006699'];
        const accentColors = ['#3b82f6', '#10b981', '#8b5cf6'];
        
        // „Åô„Åπ„Å¶„ÅÆ„ÉÜ„Ç≠„Çπ„ÉàË¶ÅÁ¥†„ÅÆËâ≤„Çí„ÉÅ„Çß„ÉÉ„ÇØ
        const allElements = document.querySelectorAll('*');
        const colorMap = new Map();
        
        allElements.forEach(elem => {
            const color = window.getComputedStyle(elem).color;
            if (color && color !== 'rgba(0, 0, 0, 0)') {
                if (!colorMap.has(color)) {
                    colorMap.set(color, []);
                }
                colorMap.get(color).push(elem);
            }
        });
        
        // Ëâ≤„ÅÆ‰ΩøÁî®È†ªÂ∫¶„Çí„ÉÅ„Çß„ÉÉ„ÇØ
        console.log('üé® ‰ΩøÁî®„Åï„Çå„Å¶„ÅÑ„ÇãËâ≤:', colorMap.size);
    }

    // „Çπ„Çø„Ç§„É´„ÇíËá™Âãï‰øÆÊ≠£
    function autoFixStyles() {
        console.log('üîß „Çπ„Çø„Ç§„É´„ÅÆËá™Âãï‰øÆÊ≠£„ÇíÈñãÂßã...');
        let fixCount = 0;
        
        validationResults.forEach(result => {
            if (result.severity === 'high' || result.severity === 'medium') {
                fixCount += fixStyle(result);
            }
        });
        
        console.log(`‚úÖ ${fixCount}ÂÄã„ÅÆ„Çπ„Çø„Ç§„É´„Çí‰øÆÊ≠£„Åó„Åæ„Åó„Åü`);
        return fixCount;
    }

    // ÂÄãÂà•„ÅÆ„Çπ„Çø„Ç§„É´‰øÆÊ≠£
    function fixStyle(result) {
        const { element, type, expected } = result;
        
        try {
            switch (type) {
                case 'fontSize':
                    const targetSize = (expected.min + expected.max) / 2;
                    element.style.fontSize = `${targetSize}${expected.unit}`;
                    break;
                    
                case 'lineHeight':
                    const targetLineHeight = (expected.min + expected.max) / 2;
                    element.style.lineHeight = targetLineHeight.toString();
                    break;
                    
                case 'marginBottom':
                    const targetMargin = (expected.min + expected.max) / 2;
                    element.style.marginBottom = `${targetMargin}${expected.unit}`;
                    break;
                    
                case 'padding':
                    const targetPadding = (expected.min + expected.max) / 2;
                    element.style.padding = `${targetPadding}${expected.unit}`;
                    break;
            }
            
            return 1;
        } catch (e) {
            console.error('‰øÆÊ≠£„Ç®„É©„Éº:', e);
            return 0;
        }
    }

    // Ëá™ÂæãÁöÑ„É´„Éº„Éó„Åß‰øÆÊ≠£
    async function runAutoFixLoop(maxIterations = 5) {
        console.log('üîÑ Ëá™ÂæãÁöÑ„Çπ„Çø„Ç§„É´‰øÆÊ≠£„É´„Éº„Éó„ÇíÈñãÂßã...');
        let iteration = 0;
        let totalIssues = Infinity;
        
        while (iteration < maxIterations && totalIssues > 0) {
            iteration++;
            console.log(`\n--- „Ç§„ÉÜ„É¨„Éº„Ç∑„Éß„É≥ ${iteration} ---`);
            
            // Ê§úË®ºÂÆüË°å
            const results = validateStyles();
            totalIssues = results.filter(r => r.severity === 'high' || r.severity === 'medium').length;
            
            console.log(`Áô∫Ë¶ã„Åï„Çå„ÅüÂïèÈ°å: ${totalIssues}ÂÄã`);
            
            if (totalIssues === 0) {
                console.log('‚ú® „Åô„Åπ„Å¶„ÅÆ„Çπ„Çø„Ç§„É´„ÅåÂü∫Ê∫ñ„ÇíÊ∫Ä„Åü„Åó„Å¶„ÅÑ„Åæ„ÅôÔºÅ');
                break;
            }
            
            // ‰øÆÊ≠£ÂÆüË°å
            const fixed = autoFixStyles();
            
            // Â∞ë„ÅóÂæÖÊ©üÔºàDOM„ÅÆÊõ¥Êñ∞„ÇíÂæÖ„Å§Ôºâ
            await new Promise(resolve => setTimeout(resolve, 100));
            
            // ‰øÆÊ≠£„ÅåÈÄ≤„Çì„Åß„ÅÑ„Å™„ÅÑÂ†¥Âêà„ÅØÁµÇ‰∫Ü
            if (fixed === 0) {
                console.log('‚ö†Ô∏è „Åì„Çå‰ª•‰∏ä„ÅÆËá™Âãï‰øÆÊ≠£„ÅØÂõ∞Èõ£„Åß„Åô');
                break;
            }
        }
        
        // ÊúÄÁµÇ„É¨„Éù„Éº„Éà
        generateReport();
    }

    // „É¨„Éù„Éº„ÉàÁîüÊàê
    function generateReport() {
        const finalResults = validateStyles();
        const highSeverity = finalResults.filter(r => r.severity === 'high').length;
        const mediumSeverity = finalResults.filter(r => r.severity === 'medium').length;
        const lowSeverity = finalResults.filter(r => r.severity === 'low').length;
        
        console.log('\nüìä ÊúÄÁµÇ„É¨„Éù„Éº„Éà:');
        console.log(`- ÈáçÂ§ß„Å™ÂïèÈ°å: ${highSeverity}ÂÄã`);
        console.log(`- ‰∏≠Á®ãÂ∫¶„ÅÆÂïèÈ°å: ${mediumSeverity}ÂÄã`);
        console.log(`- ËªΩÂæÆ„Å™ÂïèÈ°å: ${lowSeverity}ÂÄã`);
        
        if (highSeverity === 0 && mediumSeverity === 0) {
            console.log('üéâ „Çπ„É©„Ç§„Éâ„ÅÆ„Çπ„Çø„Ç§„É´„ÅØÈ´òÂìÅË≥™Âü∫Ê∫ñ„ÇíÊ∫Ä„Åü„Åó„Å¶„ÅÑ„Åæ„ÅôÔºÅ');
        }
        
        return {
            high: highSeverity,
            medium: mediumSeverity,
            low: lowSeverity,
            total: finalResults.length
        };
    }

    // ÊâãÂãïÂÆüË°åÁî®„ÅÆAPI
    window.GenSpaStyleValidator = {
        validate: validateStyles,
        autoFix: autoFixStyles,
        runAutoFixLoop: runAutoFixLoop,
        generateReport: generateReport
    };

    // DOM„É≠„Éº„ÉâÂæå„Å´Ëá™ÂãïÂÆüË°å
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => runAutoFixLoop(), 1000);
        });
    } else {
        setTimeout(() => runAutoFixLoop(), 1000);
    }

})();